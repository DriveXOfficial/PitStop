<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DriveX — Pit Strategy Simulator</title>
<style>
:root{
  --bg-main:#0A0F2C;
  --bg-card:#0A0A0A;
  --accent:#C5A253;
  --accent-light:#FFFFFF;
  --muted:#94a3b8;
  --flag-blue:#0055A4;
  --flag-white:#FFFFFF;
  --flag-red:#EF4135;
}
*{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
body{margin:0;background:var(--bg-main);color:var(--accent-light);}
h1,h2,h3{margin:0;}
h1{font-size:1.8em;color:var(--accent);}
h2{font-size:1.2em;color:var(--accent);margin-bottom:8px;}
h3{font-size:1em;color:var(--accent-light);margin-top:12px;}
label{display:block;margin-top:10px;color:var(--muted);}
input,select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:inherit;}
button{cursor:pointer;border:none;border-radius:8px;padding:8px 12px;font-weight:700;}
.btn{background:var(--accent);color:#0A0A0A;}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--accent);}
.app{max-width:1150px;margin:28px auto;padding:20px;display:grid;grid-template-columns:360px 1fr 320px;gap:18px;}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.05);padding:16px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.6);}
.row{display:flex;gap:8px;align-items:center;}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px;}
th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);}
.small{font-size:12px;color:var(--muted);}
.big-number{font-size:28px;font-weight:700;}
.history-box{max-height:320px;overflow:auto;}
.kpi{display:flex;gap:12px;flex-wrap:wrap;}
.kpi .card{padding:12px;}
footer{max-width:1150px;margin:8px auto 40px;color:var(--muted);font-size:13px;text-align:center;}
/* --- Popup paramètres --- */
.popup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:1000;}
.popup-content{background:var(--bg-main);border-radius:16px;border:1px solid rgba(197,162,83,0.4);padding:25px;width:90%;max-width:600px;box-shadow:0 0 25px rgba(197,162,83,0.3);animation:fadeIn 0.3s ease;}
.close-btn{background:red;float:right;font-weight:bold;border-radius:8px;padding:4px 8px;color:white;}
@keyframes fadeIn{from{opacity:0;transform:scale(0.95);}to{opacity:1;transform:scale(1);}}

/* --- Widget Apple-style interactif --- */
#pit_widget{
  position:fixed;bottom:20px;right:20px;width:220px;padding:12px;background:rgba(10,15,44,0.9);border-radius:16px;border:1px solid rgba(197,162,83,0.4);box-shadow:0 4px 20px rgba(197,162,83,0.4);color:var(--accent-light);font-weight:600;z-index:999;transition:all 0.6s ease;
}
#pit_widget:hover{width:300px;padding:18px;box-shadow:0 6px 30px rgba(197,162,83,0.6);}
#pit_widget .bar-bg{width:100%;height:10px;background:rgba(255,255,255,0.05);border-radius:8px;margin-top:8px;}
#pit_widget .bar-fill{height:10px;width:0%;background:var(--accent);border-radius:8px;transition:width 0.3s;}
#pit_widget .extra-info{display:none;margin-top:10px;font-size:12px;color:var(--accent-light);}
#pit_widget:hover .extra-info{display:block;}
</style>
</head>
<body>
<header style="text-align:center;padding:20px;">
  <h1>DriveX Academy- Simulateur de stratégie de pit</h1>
  <p class="small">Fichier autonome HTML/JS/CSS — Déposez sur GitHub Pages</p>
</header>

<button id="openSetup" class="btn" style="margin:0 auto;display:block;">⚙️ Paramètres avant-course</button>

<div class="app">
  <!-- Colonne gauche: Paramètres rapides -->
  <div class="card">
    <h2>Paramètres rapides</h2>
    <label>Durée moyenne d'un tour (s)</label><input id="input_tour_moyen" value="90">
    <label>Consommation carburant par tour (L)</label><input id="input_conso_tour" value="2.8">
    <label>Marge carburant (tours)</label><input id="input_marge_tours" value="1">
    <label>Temps base arrêt aux stands (s)</label><input id="input_pit_base" value="20">
    <label>Changement pneus (s)</label><input id="input_changement_pneu" value="25">
    <div style="margin-top:12px;" class="row">
      <button class="btn" id="save_params">Sauvegarder</button>
      <button class="btn-ghost" id="reset_all">Réinitialiser</button>
    </div>
  </div>

  <!-- Middle: Course -->
  <div class="card">
    <h2>Course — Saisie tour par tour</h2>
    <div class="row">
      <label style="flex:1">Tour # <input id="tour_actuel" type="number" min="1" value="1" style="width:80px;margin-left:8px"></label>
      <label style="flex:1">Chrono du tour (s) <input id="chrono_tour" value="" style="width:120px;margin-left:8px"></label>
    </div>
    <label style="margin-top:8px">Dégâts</label>
    <select id="degat_select">
      <option value="none">Aucun</option>
      <option value="avant">Aileron avant</option>
      <option value="arriere">Aileron arrière</option>
      <option value="suspension">Suspension</option>
    </select>
    <label style="margin-top:8px">Carburant restant (L)</label><input id="fuel_restant">
    <div style="margin-top:10px;" class="row">
      <button class="btn" id="ajouter_tour">Enregistrer ce tour</button>
      <button class="btn-ghost" id="undo_tour">Annuler dernier</button>
    </div>
    <h3>Conseil instantané</h3>
    <div id="advice_box" style="padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)">Aucune donnée — commencez à enregistrer des tours</div>
    <h3>Historique des tours</h3>
    <div class="history-box">
      <table id="table_history">
        <thead><tr><th>Tour</th><th>Chrono</th><th>Dégât</th><th>Fuel (L)</th><th>Conseil</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Right: KPI -->
  <div class="card">
    <h2>KPIs & Arrêts</h2>
    <div class="kpi">
      <div class="card" style="flex:1">
        <div class="small">Tours restants estimés</div>
        <div id="kpi_tours_restants" class="big-number">—</div>
      </div>
      <div class="card" style="flex:1">
        <div class="small">Autonomie (tours)</div>
        <div id="kpi_autonomie" class="big-number">—</div>
      </div>
    </div>
  </div>
</div>

<!-- Popup paramètres détaillés -->
<div id="popupSetup" class="popup">
  <div class="popup-content">
    <span id="closeSetup" class="close-btn">✕</span>
    <h2>Paramètres avant-course détaillés</h2>
    <label>Durée de la course (min)</label><input id="popup_course_minutes">
    <label>Nombre de tours</label><input id="popup_course_tours">
    <label>Capacité réservoir (L)</label><input id="popup_reservoir_max">
    <label>Temps réparation aileron avant (s)</label><input id="popup_rep_avant">
    <label>Temps réparation aileron arrière (s)</label><input id="popup_rep_arriere">
    <label>Temps réparation suspension (s)</label><input id="popup_rep_susp">
    <label>Perte par tour aileron avant cassé (s)</label><input id="popup_pen_avant">
    <label>Perte par tour aileron arrière cassé (s)</label><input id="popup_pen_arriere">
    <label>Perte par tour suspension abîmée (s)</label><input id="popup_pen_susp">
    <label>Usure pneus (perte s/tour)</label><input id="popup_pen_pneu">
    <div class="row" style="margin-top:12px;">
      <button class="btn" id="popup_save">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Widget -->
<div id="pit_widget">
  <div><strong>PitStop</strong></div>
  <div>Tours restants: <span id="pit_remaining">—</span></div>
  <div class="bar-bg"><div id="pit_bar" class="bar-fill"></div></div>
  <div class="extra-info">
    Carburant à remettre: <span id="pit_fuel">—</span> L<br>
    Dégâts cumulés: <span id="pit_damage">—</span><br>
    Temps estimé pitstop: <span id="pit_time">—</span> s
  </div>
</div>

<footer>DriveX Official — Version autonome HTML/JS/CSS</footer>

<script>
// --- Utils ---
const $ = id=>document.getElementById(id);
const toNum=v=>v===''?NaN:parseFloat(v);

// --- État ---
let params = {};
let tours = [];

// --- Chargement / sauvegarde ---
function loadParams(){
  const p = JSON.parse(localStorage.getItem('dx_params')||'{}');
  params = p;
  ['course_minutes','course_tours','tour_moyen','conso_tour','reservoir_max','pit_base','changement_pneu','marge_tours'].forEach(k=>{
    if($(k)) $(k).value = p[k]||'';
    if($('popup_'+k)) $('popup_'+k).value = p[k]||'';
  });
}
function saveParams(){
  ['course_minutes','course_tours','tour_moyen','conso_tour','reservoir_max','pit_base','changement_pneu','marge_tours'].forEach(k=>{
    const val = $(k).value; if(val) params[k]=toNum(val);
  });
  localStorage.setItem('dx_params',JSON.stringify(params));
  computeKPIs(); updatePitWidget();
}
loadParams();

// --- Tours ---
function loadTours(){ tours = JSON.parse(localStorage.getItem('dx_tours')||'[]'); renderHistory(); computeKPIs(); updatePitWidget();}
function saveTours(){ localStorage.setItem('dx_tours',JSON.stringify(tours));}

// --- Historique ---
function renderHistory(){
  const tbody = document.querySelector('#table_history tbody');
  tbody.innerHTML='';
  tours.forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.tour}</td><td>${isNaN(t.chrono)?'—':t.chrono}</td><td>${t.degat}</td><td>${isNaN(t.fuel)?'—':t.fuel}</td><td>${t.conseil||''}</td>`;
    tbody.appendChild(tr);
  });
}

// --- Ajout tour ---
function addTour(){
  const t={tour:toNum($('tour_actuel').value), chrono:toNum($('chrono_tour').value), degat:$('degat_select').value, fuel:toNum($('fuel_restant').value)};
  t.conseil='Continuer';
  tours.push(t); saveTours(); renderHistory(); computeKPIs(); updatePitWidget();
  $('tour_actuel').value = t.tour+1; $('chrono_tour').value='';
}
$('ajouter_tour').addEventListener('click',addTour);
$('undo_tour').addEventListener('click',()=>{if(tours.length){tours.pop();saveTours();renderHistory();computeKPIs();updatePitWidget();}});

// --- KPIs ---
function computeKPIs(){
  const last = tours[tours.length-1];
  let fuel = last?last.fuel:params.reservoir_max;
  $('kpi_autonomie').textContent = isNaN(fuel)?'—':(fuel/params.conso_tour).toFixed(1);
  let tours_rest = params.course_tours ? Math.max(0,(params.course_tours - (last?last.tour:0))) : Math.max(0, Math.ceil((params.course_minutes*60 - ((last?last.tour:0)*params.tour_moyen))/params.tour_moyen));
  $('kpi_tours_restants').textContent = tours_rest;
}

// --- Widget ---
function updatePitWidget(){
  const last = tours[tours.length-1];
  let fuel = last?last.fuel:params.reservoir_max;
  let tours_rest = params.course_tours ? Math.max(0,(params.course_tours - (last?last.tour:0))) : Math.max(0, Math.ceil((params.course_minutes*60 - ((last?last.tour:0)*params.tour_moyen))/params.tour_moyen));
  const fuel_needed = tours_rest*params.conso_tour + params.marge_tours*params.conso_tour;
  const fuel_to_add = Math.max(0, Math.min(params.reservoir_max-fuel, fuel_needed-fuel));
  $('pit_remaining').textContent = tours_rest;
  $('pit_bar').style.width = (100 - Math.min(100, (params.marge_tours/Math.max(1,tours_rest))*100))+'%';
  const damages = tours.filter(t=>t.degat!=='none').map(t=>t.degat).join(', ')||'Aucun';
  $('pit_damage').textContent = damages;
  const pit_time = params.pit_base + params.changement_pneu + fuel_to_add*0.18;
  $('pit_time').textContent = pit_time.toFixed(1);
}

// --- Popup ---
$('openSetup').addEventListener('click',()=>{$('popupSetup').style.display='flex';});
$('closeSetup').addEventListener('click',()=>{$('popupSetup').style.display='none';});
$('popup_save').addEventListener('click',()=>{
  ['course_minutes','course_tours','tour_moyen','conso_tour','reservoir_max','pit_base','changement_pneu','marge_tours'].forEach(k=>{
    const val=$('popup_'+k).value; if(val) params[k]=toNum(val);
  });
  localStorage.setItem('dx_params',JSON.stringify(params));
  $('popupSetup').style.display='none';
  computeKPIs(); updatePitWidget();
  alert('Paramètres avant-course sauvegardés');
});

// --- Sauvegarde rapide ---
$('save_params').addEventListener('click',saveParams);
$('reset_all').addEventListener('click',()=>{if(confirm('Réinitialiser tout ?')){localStorage.clear();location.reload();}});
loadTours(); updatePitWidget();
</script>
</body>
</html>
